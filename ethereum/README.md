# Ethereum Contracts

This directory contains smart contracts utilized by the Polkadot-Ethereum Bridge.

- Bridge.sol: application registry and routing of messages from Substrate
- Application.sol: an abstract contract that must be implemented by any Bridge application
    - ETHApp.sol: application for cross-chain ETH transfers between Ethereum and Substrate
    - ERC20App.sol: application for cross-chain ERC20 transfers between Ethereum and Substrate
- Verifier.sol: verifies tx origin and signatures
- ScaleCodec.sol: SCALE encoding and decoding

## Set up

After starting the blockchain and deploying the contracts, the Bridge's Ethereum component is ready for usage.

Install Ganache
```bash
yarn global add ganache-cli
```

---
**NOTE**

Make sure to read [Yearn docs](https://classic.yarnpkg.com/en/docs/cli/global/) regarding global packages and path in case `Ganache` is not working.

Alternatively, you could skip this step and install dependencies locally in the next step. In that case `Ganache` will be installed only for the current project and you'll need to invoke it with `yarn run ganache-cli`.

Please, also note that if you have not installed `truffle` as a global package you will need to prefix commands with `yarn run...` in order to use locally installed package.

---

Install dependencies with yarn:

```bash
yarn install
```

Set up `.env` file. Note that deploying to ropsten network requires modifying the INFURA_PROJECT_ID and MNEMONIC environment variables.

```bash
cp .env.example .env
```

Start a ganache instance:

```bash
ganache-cli \
    --port=8545 \
    --blockTime=0 \
    --networkId=344 \
    --deterministic \
    --mnemonic='stone speak what ritual switch pigeon weird dutch burst shaft nature shove'
```

Open a fresh terminal window and deploy the contracts:

```bash
truffle deploy --network e2e_test
```

## Testing

Make sure the truffle environment is running, then run tests

```bash
# Start testing environment if it's not already running
ganache-cli \
    --port=8545 \
    --blockTime=0 \
    --networkId=344 \
    --deterministic \
    --mnemonic='stone speak what ritual switch pigeon weird dutch burst shaft nature shove'

# In a new terminal, test application gas expenditures
truffle test test/test_gas.js --network e2e_test

# Run all tests
truffle test --network e2e_test
```

## Scripts


The project includes several scripts for Bridge interaction:

`getTx.js` gets information about a transaction

``` bash
truffle exec scripts/getTx.js [tx-hash] --network e2e_test
```

`getEthBalance.js` gets an address' ETH balance

``` bash
truffle exec scripts/getEthBalance.js [ethereum-address] --network e2e_test
```

`getERC20balance.js` gets an address' ERC20 token balance

``` bash
truffle exec scripts/getERC20Balance.js [ethereum-address] [token-contract-address] --network e2e_test
```

`sendEth.js` deposits ETH into the ETHApp, initiating a cross-chain transfer to Substrate

``` bash
truffle exec scripts/sendEth.js [amount] [polkadot-recipient] --network e2e_test
```

`sendERC20.js` deposits ERC20 tokens into the ERC20App, initiating a cross-chain transfer to Substrate

``` bash
truffle exec scripts/sendERC20.js [amount] [token-contract-address] [polkadot-recipient] --network e2e_test
```


## Autogenerated Documentation

Solidity documentation can be autogenerated using the [solidity-docgen](https://github.com/OpenZeppelin/solidity-docgen) library. It will generate markdown files from the contracts directory and output them to the docs directory.

```bash
# The library is only compatible with npx
npx solidity-docgen
```
